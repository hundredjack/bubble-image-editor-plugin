function initializeImageEditor(e,o){console.log("[Image Editor] Initializing element");var t=document.createElement("iframe");t.setAttribute("id","image-editor-iframe-"+Date.now()),t.style.width="100%",t.style.height="100%",t.style.border="none",t.style.overflow="hidden",t.setAttribute("allow","clipboard-read; clipboard-write"),e.data.iframe=t,e.data.editorReady=!1,e.data.messageQueue=[],e.data.autoLoadExecuted=!1;var a=function(o){if(e.data.editorUrl){var a=new URL(e.data.editorUrl).origin;if(o.origin===a){var r=o.data;if(r&&r.type)switch(console.log("[Image Editor] Received message:",r.type),r.type){case"editor_ready":console.log("[Image Editor] Editor is ready"),e.data.editorReady=!0,e.publishState("is_loaded",!0),e.publishState("error_message",""),e.triggerEvent("Editor loaded"),e.data.messageQueue.length>0&&(console.log("[Image Editor] Processing",e.data.messageQueue.length,"queued messages"),e.data.messageQueue.forEach(function(e){t.contentWindow.postMessage(e,a)}),e.data.messageQueue=[]);break;case"image_loaded":console.log("[Image Editor] Image loaded:",r.image),e.publishState("current_image_url",r.image||""),e.publishState("current_user_id",r.userId||""),e.publishState("is_modified",!1),e.publishState("error_message",""),e.triggerEvent("Image loaded",{url:r.image,userId:r.userId});break;case"image_modified":console.log("[Image Editor] Image modified"),e.publishState("is_modified",!0),e.triggerEvent("Image modified");break;case"export_started":console.log("[Image Editor] Export started"),e.publishState("export_status","exporting"),e.publishState("error_message",""),e.triggerEvent("Export started");break;case"export_success":console.log("[Image Editor] Export success"),e.publishState("export_status","success"),e.publishState("last_export_timestamp",new Date),e.publishState("error_message",""),e.triggerEvent("Export completed",{timestamp:new Date});break;case"export_error":console.error("[Image Editor] Export error:",r.error),e.publishState("export_status","error"),e.publishState("error_message",r.error||"Export failed"),e.triggerEvent("Export failed",{error:r.error||"Export failed"});break;case"error":console.error("[Image Editor] Editor error:",r.error),e.publishState("error_message",r.error||"Unknown error"),e.triggerEvent("Editor error",{error:r.error||"Unknown error"});break;case"image_data":if(console.log("[Image Editor] Received image data for download"),r.imageData&&e.data.downloadFilename){var i=document.createElement("a");i.href=r.imageData,i.download=e.data.downloadFilename,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),delete e.data.downloadFilename,console.log("[Image Editor] Image download initiated")}else console.error("[Image Editor] Invalid image data received for download"),e.publishState("error_message","Failed to get image data for download"),e.triggerEvent("Editor error",{error:"Failed to get image data for download"});break;default:console.warn("[Image Editor] Unknown message type:",r.type)}}else console.warn("[Image Editor] Received message from unauthorized origin:",o.origin)}};window.addEventListener("message",a),e.data.messageHandler=a,t.addEventListener("load",function(){console.log("[Image Editor] Iframe loaded")}),t.addEventListener("error",function(o){console.error("[Image Editor] Iframe load error:",o),e.publishState("error_message","Failed to load editor"),e.triggerEvent("Editor error",{error:"Failed to load editor"})}),e.canvas.append(t),e.publishState("is_loaded",!1),e.publishState("is_modified",!1),e.publishState("export_status","idle"),e.publishState("current_image_url",""),e.publishState("current_user_id",""),e.publishState("error_message",""),e.publishState("last_export_timestamp",null),console.log("[Image Editor] Element initialized")}function updateImageEditor(e,o){if(e.data.iframe){if(console.log("[Image Editor] Updating element properties"),o.editor_url!==e.data.editorUrl){var t=o.editor_url||"https://lmqkf0940zey.space.minimax.io";console.log("[Image Editor] Updating editor URL to:",t),e.data.editorUrl=t,e.data.iframe.setAttribute("src",t),e.data.editorReady=!1,e.data.autoLoadExecuted=!1,e.publishState("is_loaded",!1),e.publishState("is_modified",!1),e.publishState("export_status","idle")}e.data.webhookUrl=o.webhook_url||"",e.data.userId=o.user_id||"",e.data.autoLoad=o.auto_load_on_start||!1,console.log("[Image Editor] Properties updated - webhook:",e.data.webhookUrl,"userId:",e.data.userId)}else console.warn("[Image Editor] Update called before initialization")}function resetImageEditor(e){if(console.log("[Image Editor] Resetting element"),e.data.iframe&&e.data.editorReady&&e.data.editorUrl){var o=new URL(e.data.editorUrl).origin;e.data.iframe.contentWindow.postMessage({type:"reset"},o)}e.publishState("is_modified",!1),e.publishState("current_image_url",""),e.publishState("current_user_id",""),e.publishState("export_status","idle"),e.publishState("error_message","")}function actionLoadImage(e,o){console.log("[Image Editor] Action: Load Image");var t=e.element;if(t&&t.data)if(t.data.iframe)if(t.data.editorUrl){var a=e.image_url||"",r=e.user_id||"";if(a){console.log("[Image Editor] Loading image:",a,"for user:",r);var i=new URL(t.data.editorUrl).origin,d={type:"load_image",image:a,userId:r};t.data.editorReady?t.data.iframe.contentWindow.postMessage(d,i):(console.log("[Image Editor] Editor not ready, queueing message"),t.data.messageQueue.push(d))}else console.warn("[Image Editor] No image URL provided to Load Image action")}else console.error("[Image Editor] Editor URL not configured");else console.error("[Image Editor] Element not initialized");else console.error("[Image Editor] No element reference provided to Load Image action")}function actionExportImage(e,o){console.log("[Image Editor] Action: Export Image");var t=e.element;if(t&&t.data)if(t.data.iframe&&t.data.editorReady)if(t.data.editorUrl){var a=t.data.webhookUrl||e.webhook_url||"",r=t.data.userId||e.user_id||"";if(!a)return console.error("[Image Editor] No webhook URL configured"),t.publishState("error_message","No webhook URL configured"),void t.triggerEvent("Export failed",{error:"No webhook URL configured"});console.log("[Image Editor] Exporting to webhook:",a,"for user:",r);var i=new URL(t.data.editorUrl).origin;t.data.iframe.contentWindow.postMessage({type:"export",webhookUrl:a,userId:r},i)}else console.error("[Image Editor] Editor URL not configured");else console.error("[Image Editor] Editor not ready");else console.error("[Image Editor] No element reference provided to Export Image action")}function actionResetCanvas(e,o){console.log("[Image Editor] Action: Reset Canvas");var t=e.element;if(t&&t.data)if(t.data.iframe&&t.data.editorReady)if(t.data.editorUrl){var a=new URL(t.data.editorUrl).origin;t.data.iframe.contentWindow.postMessage({type:"reset"},a),t.publishState("is_modified",!1),t.publishState("current_image_url",""),t.publishState("export_status","idle"),t.publishState("error_message","")}else console.error("[Image Editor] Editor URL not configured");else console.warn("[Image Editor] Editor not ready, cannot reset");else console.error("[Image Editor] No element reference provided to Reset Canvas action")}function actionUndo(e,o){console.log("[Image Editor] Action: Undo");var t=e.element;if(t&&t.data)if(t.data.iframe&&t.data.editorReady)if(t.data.editorUrl){var a=new URL(t.data.editorUrl).origin;t.data.iframe.contentWindow.postMessage({type:"undo"},a)}else console.error("[Image Editor] Editor URL not configured");else console.warn("[Image Editor] Editor not ready, cannot undo");else console.error("[Image Editor] No element reference provided to Undo action")}function actionRedo(e,o){console.log("[Image Editor] Action: Redo");var t=e.element;if(t&&t.data)if(t.data.iframe&&t.data.editorReady)if(t.data.editorUrl){var a=new URL(t.data.editorUrl).origin;t.data.iframe.contentWindow.postMessage({type:"redo"},a)}else console.error("[Image Editor] Editor URL not configured");else console.warn("[Image Editor] Editor not ready, cannot redo");else console.error("[Image Editor] No element reference provided to Redo action")}function actionUploadImageFile(e,o){console.log("[Image Editor] Action: Upload Image File");var t=e.element;if(t&&t.data)if(t.data.iframe){var a=document.createElement("input");a.type="file",a.accept="image/*",a.style.display="none",a.addEventListener("change",function(o){var r=o.target.files[0];if(r){if(!r.type.startsWith("image/"))return console.error("[Image Editor] Selected file is not an image"),t.triggerEvent("Editor error"),void(t.publishState&&t.publishState("error_message","Selected file is not an image"));var i=new FileReader;i.onload=function(o){var a=o.target.result,r=e.user_id||"";if(t.data.editorUrl){var i=new URL(t.data.editorUrl).origin,d={type:"load_image",image:a,userId:r};t.data.editorReady?t.data.iframe.contentWindow.postMessage(d,i):t.data.messageQueue.push(d),t.publishState&&(t.publishState("current_image_url",a),t.publishState("current_user_id",r)),console.log("[Image Editor] Image file uploaded and loaded")}else console.error("[Image Editor] Editor URL not configured")},i.onerror=function(){console.error("[Image Editor] Error reading file"),t.triggerEvent("Editor error"),t.publishState&&t.publishState("error_message","Error reading selected file")},i.readAsDataURL(r),document.body.removeChild(a)}else console.warn("[Image Editor] No file selected")}),document.body.appendChild(a),a.click()}else console.error("[Image Editor] Element not initialized");else console.error("[Image Editor] No element reference provided to Upload Image File action")}function actionDownloadEditedImage(e,o){console.log("[Image Editor] Action: Download Edited Image");var t=e.element;if(t&&t.data)if(t.data.iframe&&t.data.editorReady)if(t.data.editorUrl){var a=e.filename||"edited-image.png";a.match(/\.(png|jpg|jpeg)$/i)||(a+=".png");var r=new URL(t.data.editorUrl).origin;t.data.downloadFilename=a,t.data.iframe.contentWindow.postMessage({type:"get_image_data",format:"png"},r),console.log("[Image Editor] Requested image data for download")}else console.error("[Image Editor] Editor URL not configured");else console.warn("[Image Editor] Editor not ready, cannot download image");else console.error("[Image Editor] No element reference provided to Download Edited Image action")}